@inject IJSRuntime JS
@implements IAsyncDisposable

<div @ref="_containerRef"
     class="parallax-container"
     style="--parallax-background-height: @BackgroundHeight;">

    <div class="parallax-background-wrapper">
        <div class="parallax-background">
            @Background
        </div>
    </div>

    <div class="parallax-foreground">
        @Foreground
    </div>
</div>

@code {
    /// <summary>
    /// Content that stays sticky and receives parallax/fade effects.
    /// Can be any content: images, videos, text overlays, etc.
    /// </summary>
    [Parameter] public RenderFragment? Background { get; set; }

    /// <summary>
    /// Content that scrolls normally over the background.
    /// </summary>
    [Parameter] public RenderFragment? Foreground { get; set; }

    /// <summary>
    /// Height of the background area. Accepts CSS units (vh, px, rem, etc.)
    /// </summary>
    [Parameter] public string BackgroundHeight { get; set; } = "50vh";

    /// <summary>
    /// Parallax speed factor. 0 = fixed (no movement), 1 = scrolls with page.
    /// Values between 0-1 create parallax effect. Default 0.5 means background
    /// moves at half the scroll speed.
    /// </summary>
    [Parameter] public double ParallaxSpeed { get; set; } = 0.5;

    /// <summary>
    /// Whether to fade the background as foreground scrolls over it.
    /// </summary>
    [Parameter] public bool EnableFade { get; set; } = true;

    /// <summary>
    /// How quickly the fade occurs. 1 = fully faded when foreground reaches
    /// top of background. Values > 1 fade faster, less than 1 fade slower.
    /// </summary>
    [Parameter] public double FadeIntensity { get; set; } = 1.0;

    private ElementReference _containerRef;
    private IJSObjectReference? _module;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _module = await JS.InvokeAsync<IJSObjectReference>(
                "import", "./Common/ParallaxView.razor.js");

            await _module.InvokeVoidAsync("init", _containerRef, new
            {
                parallaxSpeed = ParallaxSpeed,
                enableFade = EnableFade,
                fadeIntensity = FadeIntensity
            });
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_module is not null)
        {
            try
            {
                await _module.InvokeVoidAsync("destroy", _containerRef);
            }
            catch (JSDisconnectedException)
            {
                // Circuit disconnected, cleanup not needed
            }
            await _module.DisposeAsync();
        }
    }
}
